<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0" />
    <title>Audio Service Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 50px auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
        margin-top: 0;
      }
      .section {
        margin: 20px 0;
        padding: 15px;
        background: #f9f9f9;
        border-left: 4px solid #007bff;
        border-radius: 4px;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
        font-size: 14px;
        cursor: pointer;
        border: none;
        border-radius: 4px;
        background: #007bff;
        color: white;
        transition: background 0.3s;
      }
      button:hover {
        background: #0056b3;
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        font-weight: bold;
      }
      .status.connected {
        background: #d4edda;
        color: #155724;
      }
      .status.disconnected {
        background: #f8d7da;
        color: #721c24;
      }
      .log {
        background: #1e1e1e;
        color: #00ff00;
        padding: 10px;
        border-radius: 4px;
        max-height: 300px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üéôÔ∏è Audio Service Test</h1>

      <div class="section">
        <h2>Connection Status</h2>
        <div
          id="status"
          class="status disconnected">
          üî¥ Not Initialized
        </div>
      </div>

      <div class="section">
        <h2>Controls</h2>
        <button id="initBtn">Initialize Audio</button>
        <button
          id="stopBtn"
          disabled>
          Stop Recording
        </button>
        <button
          id="pauseBtn"
          disabled>
          Pause Microphone
        </button>
        <button
          id="resumeBtn"
          disabled>
          Resume Microphone
        </button>
        <button
          id="cleanupBtn"
          disabled>
          Cleanup
        </button>
      </div>

      <div class="section">
        <h2>Events Log</h2>
        <button
          id="clearLogBtn"
          style="background: #6c757d">
          Clear Log
        </button>
        <div
          id="log"
          class="log">
          Ready for events...
        </div>
      </div>
    </div>

    <script type="module">
      import {AudioService, AudioState, EventEmitter} from "../dist/esm/index.js";

      // Initialize services
      const eventEmitter = new EventEmitter();
      const audioState = new AudioState();

      const audioService = new AudioService(eventEmitter, audioState, {
        processorPath: "/dist/audio-processor.js",
        constraints: {
          sampleRate: 16000,
          channelCount: 1,
          echoCancellation: true,
          noiseSuppression: true,
          autoGainControl: true
        },
        processor: {
          voiceThreshold: 0.3,
          silenceThreshold: 0.15,
          minSilenceFrames: 10
        },
        playbackRetryInterval: 100,
        resumeDelay: 100,
        failsafeResumeTimeout: 3000
      });

      // UI Elements
      const statusEl = document.getElementById("status");
      const initBtn = document.getElementById("initBtn");
      const stopBtn = document.getElementById("stopBtn");
      const pauseBtn = document.getElementById("pauseBtn");
      const resumeBtn = document.getElementById("resumeBtn");
      const cleanupBtn = document.getElementById("cleanupBtn");
      const clearLogBtn = document.getElementById("clearLogBtn");
      const logEl = document.getElementById("log");
      const recordingStateEl = document.getElementById("recordingState");
      const bytesSentEl = document.getElementById("bytesSent");
      const bytesReceivedEl = document.getElementById("bytesReceived");
      const bufferSizeEl = document.getElementById("bufferSize");

      // Helper function to log messages
      function log(message, type = "info") {
        const timestamp = new Date().toLocaleTimeString();
        const color = type === "error" ? "#ff6b6b" : type === "success" ? "#00ff00" : "#00aaff";
        const logLine = `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
        logEl.innerHTML += logLine;
        logEl.scrollTop = logEl.scrollHeight;
      }

      // Event listeners from AudioService
      eventEmitter.on("user_recording_started", event => {
        log("‚úÖ Recording started", "success");
        statusEl.className = "status connected";
        statusEl.textContent = "üü¢ Recording Active";
        stopBtn.disabled = false;
        pauseBtn.disabled = false;
      });

      eventEmitter.on("user_recording_stopped", event => {
        log("‚èπ Recording stopped", "info");
        statusEl.className = "status disconnected";
        statusEl.textContent = "üî¥ Recording Stopped";
        stopBtn.disabled = true;
        pauseBtn.disabled = true;
        resumeBtn.disabled = true;
      });

      eventEmitter.on("user_recording_data", event => {
        log(`üì§ Audio data: ${event.byteLength} bytes`, "info");
      });

      eventEmitter.on("voice_detected", event => {
        log(`üé§ Voice detected (RMS: ${event.rms?.toFixed(4)}, dB: ${event.db?.toFixed(1)})`, "success");
      });

      eventEmitter.on("voice_ended", event => {
        log(`‚èπ Voice ended (Duration: ${event.duration}ms)`, "info");
      });

      eventEmitter.on("error", event => {
        log(`‚ùå Error: ${event.message}`, "error");
      });

      // Button handlers
      initBtn.onclick = async () => {
        try {
          log("üîß Initializing audio service...", "info");
          await audioService.initialize();
          log("‚úÖ Audio service initialized", "success");
          initBtn.disabled = true;
          cleanupBtn.disabled = false;
        } catch (error) {
          log(`‚ùå Init failed: ${error.message}`, "error");
        }
      };

      stopBtn.onclick = async () => {
        try {
          log("‚èπ Stopping recording...", "info");
          audioService.audioCollector.processAndEncode();
          // Stop recording if method exists
          log("‚úÖ Recording stopped", "success");
        } catch (error) {
          log(`‚ùå Stop failed: ${error.message}`, "error");
        }
      };

      pauseBtn.onclick = async () => {
        try {
          log("‚è∏ Pausing microphone...", "info");
          await audioService.pauseMicrophone();
          log("‚úÖ Microphone paused", "success");
          pauseBtn.disabled = true;
          resumeBtn.disabled = false;
        } catch (error) {
          log(`‚ùå Pause failed: ${error.message}`, "error");
        }
      };

      resumeBtn.onclick = async () => {
        try {
          log("‚ñ∂Ô∏è Resuming microphone...", "info");
          await audioService.resumeMicrophone();
          log("‚úÖ Microphone resumed", "success");
          pauseBtn.disabled = false;
          resumeBtn.disabled = true;
        } catch (error) {
          log(`‚ùå Resume failed: ${error.message}`, "error");
        }
      };

      cleanupBtn.onclick = async () => {
        try {
          log("üßπ Cleaning up...", "info");
          await audioService.cleanup();
          log("‚úÖ Cleanup complete", "success");
          statusEl.className = "status disconnected";
          statusEl.textContent = "üî¥ Cleaned Up";
          initBtn.disabled = false;
          stopBtn.disabled = true;
          pauseBtn.disabled = true;
          resumeBtn.disabled = true;
          cleanupBtn.disabled = true;
        } catch (error) {
          log(`‚ùå Cleanup failed: ${error.message}`, "error");
        }
      };

      clearLogBtn.onclick = () => {
        logEl.innerHTML = "";
        log("üìã Log cleared", "info");
      };

      log("üéôÔ∏è Audio Service Test initialized", "success");
    </script>
  </body>
</html>
